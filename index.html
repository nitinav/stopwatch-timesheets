<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stopwatch</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        #stopwatch {
            font-size: 2rem;
            margin: 50px auto;
            text-align: center;
        }
        #stopwatchButtons {
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <a href="index.html" class="active">Home</a>
        <a href="editSplits.html">Edit Splits</a>
        <a href="daily.html">Daily Summaries</a>
        <a href="weekly.html">Weekly Summaries</a>
    </div>

    <div id="stopwatch">00:00:00</div>
    <div id="stopwatchButtons">
        <button id="startStopBtn">Start</button>
        <button id="splitBtn">Split</button>
        <button id="resetBtn">Reset</button>
    </div>
    <div id="splitsContainer"></div>

    <script src="functions.js"></script>

    <script>
        let startTime;
        let lastStartTimestamp;
        let running = false;
        let pausedTime = 0;
        let splits = [];
        let existingSplits = JSON.parse(localStorage.getItem('allTimeSplits'));

        function startStopwatch() {
            if (!running) {
                startTime = performance.now() - pausedTime;
                lastStartTimestamp = Date.now();
                running = true;
                animateStopwatch();
                document.getElementById('startStopBtn').textContent = 'Pause';
            }
        }

        function pauseStopwatch() {
            if (running) {
                running = false;
                pausedTime = performance.now() - startTime;
                document.getElementById('startStopBtn').textContent = 'Start';
            }
        }

        function resetStopwatch() {
            running = false;
            pausedTime = 0;
            updateStopwatch(0);
            existingSplits = JSON.parse(localStorage.getItem('allTimeSplits'));
            document.getElementById('startStopBtn').textContent = 'Start';
            document.getElementById('splitsContainer').innerHTML = '';
            splits = [];
        }

        function splitStopwatch() {
            if (running) {
                pauseStopwatch();
                const endTime = Date.now();
                const splitTime = endTime - lastStartTimestamp;
                const split = {
                    startTime: new Date(lastStartTimestamp).toLocaleString(),
                    endTime: new Date(endTime).toLocaleString(),
                    description: '',
                    customer: '',
                    project: ''
                };
                splits.push(split);
                persistSplits();
                displaySplits();
                startStopwatch();
            }
        }

        function persistSplits() {
            localStorage.setItem("thisSessionSplits", JSON.stringify(splits));
            if (existingSplits) {
                localStorage.setItem("allTimeSplits", JSON.stringify(existingSplits.concat(splits)));
            } else {
                localStorage.setItem("allTimeSplits", JSON.stringify(splits));
            }
        }

        function animateStopwatch() {
            if (running) {
                requestAnimationFrame(animateStopwatch);
                const elapsedTime = performance.now() - startTime;
                updateStopwatch(elapsedTime);
            }
        }

        function updateStopwatch(elapsedTime) {
            const totalSeconds = Math.floor(elapsedTime / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const formattedTime = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
            document.getElementById('stopwatch').textContent = formattedTime;
        }

        function displaySplits() {
            const container = document.getElementById('splitsContainer');
            container.innerHTML = '';
            if (splits.length === 0) return;

            const table = document.createElement('table');
            table.id = 'splitsTable';
            const headerRow = table.insertRow();
            const headers = ['Split #', 'Start Time', 'End Time', 'Duration', 'Customer', 'Project', 'Description'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            splits.forEach((split, index) => {
                const row = table.insertRow();
                const splitNumberCell = row.insertCell();
                splitNumberCell.textContent = index + 1;
                const startTimeCell = row.insertCell();
                startTimeCell.textContent = split.startTime;
                const endTimeCell = row.insertCell();
                endTimeCell.textContent = split.endTime;
                const durationCell = row.insertCell();
                durationCell.textContent = formatDuration(new Date(split.endTime) - new Date(split.startTime));
                const customerCell = row.insertCell();
                const customerInput = document.createElement('input');
                customerInput.value = split.customer;
                customerInput.setAttribute("contenteditable", "true");
                customerInput.addEventListener('blur', () => {
                    split.customer = customerInput.value;
                    displaySplits();
                    persistSplits();
                });
                customerCell.appendChild(customerInput);
                const projectCell = row.insertCell();
                const projectInput = document.createElement('input');
                projectInput.value = split.project;
                projectInput.setAttribute("contenteditable", "true");
                projectInput.addEventListener('blur', () => {
                    split.project = projectInput.value;
                    displaySplits();
                    persistSplits();
                });
                projectCell.appendChild(projectInput);
                const descriptionCell = row.insertCell();
                const descriptionInput = document.createElement('input');
                descriptionInput.value = split.description;
                descriptionInput.setAttribute("contenteditable", "true");
                descriptionInput.addEventListener('blur', () => {
                    split.description = descriptionInput.value;
                    displaySplits();
                    persistSplits();
                });
                descriptionCell.appendChild(descriptionInput);
            });

            container.appendChild(table);
        }

        document.getElementById('startStopBtn').addEventListener('click', function () {
            if (running) {
                pauseStopwatch();
            } else {
                startStopwatch();
            }
        });

        document.getElementById('splitBtn').addEventListener('click', splitStopwatch);

        document.getElementById('resetBtn').addEventListener('click', resetStopwatch);

        // Start the stopwatch immediately upon loading the page
        animateStopwatch();
    </script>

</body>

</html>