<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stopwatch</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        #stopwatch {
            font-size: 2rem;
            margin: 50px auto;
            text-align: center;
        }

        #stopwatchButtons {
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <a href="index.html" class="active">Home</a>
        <a href="editSplits.html">Edit Splits</a>
        <a href="daily.html">Daily Summaries</a>
        <a href="weekly.html">Weekly Summaries</a>
    </div>

    <div id="stopwatch">00:00:00</div>
    <div id="stopwatchButtons">
        <button id="startStopBtn">Start</button>
        <button id="splitBtn">Split</button>
        <button id="resetBtn">Reset</button>
    </div>

    <h3 id="splitInProgress">In Progress Split</h3>
    <table id="inProgressSplitTable">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Customer</th>
                <th>Project</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3 id="dateDisplay"></h3>
    <table id="todaysSplitsTable">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Customer</th>
                <th>Project</th>
                <th>Description</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="functions.js"></script>

    <script>
        let startTime;
        let lastStartTimestamp;
        let running = false;
        let pausedTime = 0;
        let splits = [];
        let existingSplits = JSON.parse(localStorage.getItem('allTimeSplits'));
        let currentDate;
        let splitInProgress = {};

        function startStopwatch() {
            if (!running) {
                startTime = performance.now() - pausedTime;
                lastStartTimestamp = Date.now();
                running = true;
                animateStopwatch();
                document.getElementById('startStopBtn').textContent = 'Pause';
                splitInProgress = {
                    startTime: new Date(lastStartTimestamp).toLocaleString(),
                    endTime: new Date().toLocaleString(),
                    description: '',
                    customer: '',
                    project: ''
                };
                const tableBody = document.querySelector('#inProgressSplitTable tbody');
                tableBody.innerHTML = '';
                insertSplitToTable(splitInProgress, 'inProgressSplitTable', actions = false);
            }
        }
        function updateSplitInProgress() {
            const tableRows = document.querySelectorAll('#inProgressSplitTable tbody tr');
            const row = tableRows[0];
            let datePart = currentDate.toLocaleDateString() + ', ';
            splitInProgress.startTime = new Date(datePart + row.cells[0].children[0].value).toLocaleString();
            splitInProgress.endTime = new Date(datePart + row.cells[1].children[0].value).toLocaleString();
            splitInProgress.customer = row.cells[3].textContent;
            splitInProgress.project = row.cells[4].textContent;
            splitInProgress.description = row.cells[5].textContent;
        }

        function pauseStopwatch() {
            if (running) {
                running = false;
                pausedTime = performance.now() - startTime;
                document.getElementById('startStopBtn').textContent = 'Start';
            }
        }

        function resetStopwatch() {
            running = false;
            pausedTime = 0;
            updateStopwatch(0);
            existingSplits = JSON.parse(localStorage.getItem('allTimeSplits'));
            document.getElementById('startStopBtn').textContent = 'Start';
            splits = [];
        }

        function splitStopwatch() {
            if (running) {
                pauseStopwatch();
                const endTime = Date.now();
                const splitTime = endTime - lastStartTimestamp;
                splitInProgress.endTime = new Date(endTime).toLocaleString();
                splits.push(splitInProgress);
                insertSplitToTable(splitInProgress, 'todaysSplitsTable', actions = true);
                saveCurrentDateSplits();
                updateTotalDurationText();
                startStopwatch();
            }
        }

        function insertSplitToTable(item, tableId, actions = true) {
            const tableBodyStr = '#' + tableId + ' tbody';
            const tableBody = document.querySelector(tableBodyStr);
            const newIndex = tableBody.querySelectorAll('tr').length;
            const row = tableBody.insertRow();
            row.innerHTML = getRowInnerHtml(
                newIndex,
                item.startTime,
                item.endTime,
                item.customer,
                item.project,
                item.description,
                actions
            );
        }

        function updateTotalDurationText() {
            const todaysRows = document.querySelectorAll('#todaysSplitsTable tbody tr');
            let currentDateTotalDuration = 0;
            let datePart = currentDate.toLocaleDateString() + ', ';

            todaysRows.forEach((row, index) => {
                const startTime = new Date(datePart + row.cells[0].children[0].value);
                const endTime = new Date(datePart + row.cells[1].children[0].value);
                currentDateTotalDuration += endTime - startTime;
            });

            // Display the date at the top of the table
            document.getElementById('dateDisplay').textContent = `
                Splits for ${currentDate.toLocaleDateString()} --
                Total Duration: ${formatDuration(currentDateTotalDuration)}`;
        }

        function animateStopwatch() {
            if (running) {
                requestAnimationFrame(animateStopwatch);
                const elapsedTime = performance.now() - startTime;
                updateStopwatch(elapsedTime);
                updateInProgressSplit();
            }
        }

        function updateInProgressSplit() {
            const tableRows = document.querySelectorAll('#inProgressSplitTable tbody tr');
            if (tableRows) {
                const index = 0;
                const row = tableRows[index];
                if (row) {
                    const timeElement = row.cells[1].children[0];
                    timeElement.value = new Date().toTimeString().slice(0, 8);
                    updateDuration(timeElement, index);
                }
            }
        }

        function updateStopwatch(elapsedTime) {
            const totalSeconds = Math.floor(elapsedTime / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const formattedTime = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
            document.getElementById('stopwatch').textContent = formattedTime;
        }

        function displayCurrentDateSplits() {
            // Get the table object from DOM and reset it to empty
            const todaysSplitsTable = document.querySelector('#todaysSplitsTable');
            const tableBody = document.querySelector('#todaysSplitsTable tbody');
            tableBody.innerHTML = '';

            // Retrieve data from local storage
            let allTimeSplits = JSON.parse(localStorage.getItem('allTimeSplits')) || [];

            // Set the current date
            currentDate = new Date();

            // Filter data for the current date
            let todaysData = allTimeSplits.filter(split => {
                const startTime = new Date(split.startTime);
                return startTime.toLocaleDateString() === currentDate.toLocaleDateString();
            });

            // If no data to display, return
            if (todaysData.length === 0) return;

            todaysData.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = getRowInnerHtml(
                    index,
                    item.startTime,
                    item.endTime,
                    item.customer,
                    item.project,
                    item.description,
                    true
                );
            });

            updateTotalDurationText();
        }

        function getRowInnerHtml(index, startTime, endTime, customer, project, description, actions = true) {
            let duration = new Date(endTime) - new Date(startTime);
            let startTimeString = new Date(startTime).toTimeString().slice(0, 8);
            let endTimeString = new Date(endTime).toTimeString().slice(0, 8);
            let innerHTML = `
                    <td><input type="time" value="${startTimeString}" oninput="updateDuration(this, ${index})"></input></td>
                    <td><input type="time" value="${endTimeString}" oninput="updateDuration(this, ${index})"></input></td>
                    <td contenteditable="false">${formatDuration(duration)}</td>
                    <td contenteditable="true">${customer}</td>
                    <td contenteditable="true">${project}</td>
                    <td contenteditable="true">${description}</td>
                `;
            if (actions) {
                innerHTML += `
                    <td>
                        <select onchange="handleDropdown(this.value, ${index})">
                            <option value="">Select Action</option>
                            <option value="insertAbove">Insert Row Above</option>
                            <option value="insertBelow">Insert Row Below</option>
                            <option value="delete">Delete Row</option>
                        </select>
                    </td>
                `;
            }
            return innerHTML;
        }

        function handleDropdown(action, index) {
            const tableBody = document.querySelector('#todaysSplitsTable tbody');
            switch (action) {
                case "insertAbove":
                    insertRow(tableBody, index);
                    break;
                case "insertBelow":
                    insertRow(tableBody, index + 1);
                    break;
                case "delete":
                    tableBody.deleteRow(index);
                    break;
                default:
                    // Do nothing or handle default case
                    break;
            }
            saveCurrentDateSplits();
            displayCurrentDateSplits();
        }

        // Function to add a new row at given index
        function insertRow(tableBody, index) {
            const row = tableBody.insertRow(index);
            row.innerHTML = getRowInnerHtml(
                index,
                new Date().toLocaleString(),
                new Date().toLocaleString(),
                '',
                '',
                '',
                true
            );
        }

        function updateDuration(timeElement, index) {
            tableId = timeElement.closest('table').id;

            const tableRows = document.querySelectorAll(`#${tableId} tbody tr`);
            const row = tableRows[index];
            let datePart = currentDate.toLocaleDateString() + ', ';
            const startTime = new Date(datePart + row.cells[0].children[0].value);
            const endTime = new Date(datePart + row.cells[1].children[0].value);

            const duration = endTime - startTime;
            row.cells[2].textContent = formatDuration(duration);
        }

        function saveCurrentDateSplits() {
            const tableRows = document.querySelectorAll('#todaysSplitsTable tbody tr');
            let currentDateSplits = [];

            tableRows.forEach(row => {
                let datePart = currentDate.toLocaleDateString() + ', ';
                const startTime = new Date(datePart + row.cells[0].children[0].value).toLocaleString();
                const endTime = new Date(datePart + row.cells[1].children[0].value).toLocaleString();
                const customer = row.cells[3].textContent;
                const project = row.cells[4].textContent;
                const description = row.cells[5].textContent;
                currentDateSplits.push({ startTime, endTime, description, customer, project });
            });

            replaceRecordsForDate(currentDate, currentDateSplits);
        }

        function replaceRecordsForDate(dateToReplace, newArray) {
            // Retrieve data from local storage
            let allTimeSplits = JSON.parse(localStorage.getItem('allTimeSplits')) || [];

            // Filter records based on the given date
            const filteredRecords = allTimeSplits.filter(record => {
                const startTime = new Date(record.startTime);
                return startTime.toDateString() === dateToReplace.toDateString();
            });

            // Remove filtered records from the original array
            allTimeSplits = allTimeSplits.filter(record => !filteredRecords.includes(record));

            // Concatenate the new array with the remaining records
            allTimeSplits = allTimeSplits.concat(newArray);

            // Update local storage with the modified array
            localStorage.setItem('allTimeSplits', JSON.stringify(allTimeSplits));

            // Optionally, return the updated array
            return allTimeSplits;
        }

        // Event listeners for stopwatch buttons
        document.getElementById('startStopBtn').addEventListener('click', function () {
            if (running) {
                pauseStopwatch();
            } else {
                startStopwatch();
            }
        });
        document.getElementById('splitBtn').addEventListener('click', splitStopwatch);
        document.getElementById('resetBtn').addEventListener('click', resetStopwatch);

        // Event listener for table cell editing
        document.querySelector('#todaysSplitsTable').addEventListener('input', saveCurrentDateSplits);
        document.querySelector('#inProgressSplitTable').addEventListener('input', updateSplitInProgress);

        // Start the stopwatch immediately upon loading the page
        animateStopwatch();

        // Display today's splits immediately also
        displayCurrentDateSplits();
    </script>

</body>

</html>